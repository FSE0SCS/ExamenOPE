name: Build ExamenOPE Multi-Platform

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install ttkbootstrap pandas openpyxl matplotlib fpdf2 pillow numpy
    
    - name: Create data directory and sample Excel
      run: |
        mkdir -p data
        python -c "
        import pandas as pd
        import os
        df = pd.DataFrame({
            'Pregunta': ['Capital de España', '2+2 es igual a'],
            'Respuesta A': ['Madrid', '3'],
            'Respuesta B': ['Barcelona', '4'],
            'Respuesta C': ['Valencia', '5'],
            'Respuesta D': ['Sevilla', '6'],
            'Respuesta Correcta (Letra)': ['A', 'B'],
            'Respuesta Correcta (Texto)': ['Madrid', '4']
        })
        df.to_excel('data/cuestionario_procesado.xlsx', index=False)
        print('Sample Excel created')
        "
    
    - name: Build macOS application
      run: |
        pyinstaller \
          --onefile \
          --windowed \
          --name="ExamenOPE" \
          --add-data="data:data" \
          --hidden-import="tkinter" \
          --hidden-import="tkinter.ttk" \
          --hidden-import="ttkbootstrap" \
          --hidden-import="matplotlib.backends.backend_tkagg" \
          --hidden-import="pandas" \
          --hidden-import="openpyxl" \
          --hidden-import="fpdf" \
          --hidden-import="sqlite3" \
          --hidden-import="PIL" \
          --osx-bundle-identifier="com.examenope.app" \
          main_premium.py
    
    - name: Create DMG
      run: |
        if [ -d "dist/ExamenOPE.app" ]; then
          hdiutil create -volname "ExamenOPE" -srcfolder "dist/ExamenOPE.app" -ov -format UDZO "dist/ExamenOPE.dmg"
        fi
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ExamenOPE-macOS
        path: dist/
        retention-days: 30

  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install ttkbootstrap pandas openpyxl matplotlib fpdf2 pillow numpy
    
    - name: Create data directory and sample Excel
      run: |
        mkdir data
        python -c "import pandas as pd; df = pd.DataFrame({'Pregunta': ['Capital de España', '2+2 es igual a'], 'Respuesta A': ['Madrid', '3'], 'Respuesta B': ['Barcelona', '4'], 'Respuesta C': ['Valencia', '5'], 'Respuesta D': ['Sevilla', '6'], 'Respuesta Correcta (Letra)': ['A', 'B'], 'Respuesta Correcta (Texto)': ['Madrid', '4']}); df.to_excel('data/cuestionario_procesado.xlsx', index=False)"
    
    - name: Build Windows application
      run: |
        pyinstaller --onefile --windowed --name="ExamenOPE" --add-data="data;data" --hidden-import="tkinter" --hidden-import="tkinter.ttk" --hidden-import="ttkbootstrap" --hidden-import="matplotlib.backends.backend_tkagg" --hidden-import="pandas" --hidden-import="openpyxl" --hidden-import="fpdf" --hidden-import="sqlite3" --hidden-import="PIL" main_premium.py
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ExamenOPE-Windows
        path: dist/ExamenOPE.exe
        retention-days: 30
