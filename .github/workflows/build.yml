name: ğŸš€ Build ExamenOPE Multi-Platform

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  build-macos:
    name: ğŸ Build para macOS
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Cache dependencias
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ”§ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install ttkbootstrap pandas openpyxl matplotlib fpdf2 pillow numpy
        pip install --upgrade setuptools wheel
    
    - name: ğŸ“ Crear directorio data
      run: |
        mkdir -p data
        # Si no hay Excel, crear uno de prueba
        if [ ! -f "data/cuestionario_procesado.xlsx" ]; then
          echo "Creando Excel de prueba..."
          python -c "
import pandas as pd
import os
df = pd.DataFrame({
    'Pregunta': ['Â¿CuÃ¡l es la capital de EspaÃ±a?', 'Â¿2+2=?'],
    'Respuesta A': ['Madrid', '3'],
    'Respuesta B': ['Barcelona', '4'],
    'Respuesta C': ['Valencia', '5'],
    'Respuesta D': ['Sevilla', '6'],
    'Respuesta Correcta (Letra)': ['A', 'B'],
    'Respuesta Correcta (Texto)': ['Madrid', '4']
})
os.makedirs('data', exist_ok=True)
df.to_excel('data/cuestionario_procesado.xlsx', index=False)
print('Excel de prueba creado')
          "
        fi
    
    - name: ğŸ”¨ Compilar para macOS
      run: |
        pyinstaller --clean --noconfirm \
          --onefile \
          --windowed \
          --name="ExamenOPE" \
          --add-data="data:data" \
          --hidden-import="tkinter" \
          --hidden-import="tkinter.ttk" \
          --hidden-import="ttkbootstrap" \
          --hidden-import="matplotlib.backends.backend_tkagg" \
          --hidden-import="pandas" \
          --hidden-import="openpyxl" \
          --hidden-import="fpdf" \
          --hidden-import="sqlite3" \
          --hidden-import="PIL" \
          --exclude-module="PyQt5" \
          --exclude-module="PyQt6" \
          --exclude-module="PySide2" \
          --exclude-module="PySide6" \
          --osx-bundle-identifier="com.examenope.app" \
          main_premium.py
    
    - name: ğŸ“¦ Crear DMG
      run: |
        if [ -d "dist/ExamenOPE.app" ]; then
          # Crear DMG para distribuciÃ³n
          hdiutil create -volname "ExamenOPE" \
            -srcfolder "dist/ExamenOPE.app" \
            -ov -format UDZO \
            "dist/ExamenOPE-macOS.dmg"
          echo "âœ… DMG creado exitosamente"
        else
          echo "âŒ No se encontrÃ³ ExamenOPE.app"
          ls -la dist/
        fi
    
    - name: ğŸ“Š Info del build
      run: |
        echo "=== BUILD INFO ==="
        ls -la dist/
        if [ -d "dist/ExamenOPE.app" ]; then
          du -sh dist/ExamenOPE.app
        fi
        if [ -f "dist/ExamenOPE-macOS.dmg" ]; then
          du -sh dist/ExamenOPE-macOS.dmg
        fi
    
    - name: ğŸ“¤ Upload macOS App
      uses: actions/upload-artifact@v3
      with:
        name: ExamenOPE-macOS
        path: |
          dist/ExamenOPE.app
          dist/ExamenOPE-macOS.dmg
        retention-days: 30

  build-windows:
    name: ğŸªŸ Build para Windows
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Cache dependencias
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ”§ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install ttkbootstrap pandas openpyxl matplotlib fpdf2 pillow numpy
        pip install --upgrade setuptools wheel
    
    - name: ğŸ“ Crear directorio data
      run: |
        mkdir data
        python -c "import pandas as pd; import os; df = pd.DataFrame({'Pregunta': ['Capital de EspaÃ±a?', '2+2=?'], 'Respuesta A': ['Madrid', '3'], 'Respuesta B': ['Barcelona', '4'], 'Respuesta C': ['Valencia', '5'], 'Respuesta D': ['Sevilla', '6'], 'Respuesta Correcta (Letra)': ['A', 'B'], 'Respuesta Correcta (Texto)': ['Madrid', '4']}); os.makedirs('data', exist_ok=True); df.to_excel('data/cuestionario_procesado.xlsx', index=False); print('Excel creado')"
    
    - name: ğŸ”¨ Compilar para Windows
      run: |
        pyinstaller --clean --noconfirm --onefile --windowed --name="ExamenOPE" --add-data="data;data" --hidden-import="tkinter" --hidden-import="tkinter.ttk" --hidden-import="ttkbootstrap" --hidden-import="matplotlib.backends.backend_tkagg" --hidden-import="pandas" --hidden-import="openpyxl" --hidden-import="fpdf" --hidden-import="sqlite3" --hidden-import="PIL" --exclude-module="PyQt5" --exclude-module="PyQt6" main_premium.py
    
    - name: ğŸ“Š Info del build
      run: |
        echo "=== BUILD INFO ==="
        dir dist
        if (Test-Path "dist/ExamenOPE.exe") {
          $size = (Get-Item "dist/ExamenOPE.exe").Length / 1MB
          Write-Host "TamaÃ±o del ejecutable: $([math]::Round($size, 2)) MB"
        }
    
    - name: ğŸ“¤ Upload Windows App
      uses: actions/upload-artifact@v3
      with:
        name: ExamenOPE-Windows
        path: dist/ExamenOPE.exe
        retention-days: 30

  build-info:
    name: ğŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [build-macos, build-windows]
    if: always()
    
    steps:
    - name: ğŸ“Š Build Summary
      run: |
        echo "ğŸ‰ BUILD COMPLETADO"
        echo "=================="
        echo "âœ… macOS: ${{ needs.build-macos.result }}"
        echo "âœ… Windows: ${{ needs.build-windows.result }}"
        echo ""
        echo "ğŸ“¥ Para descargar:"
        echo "1. Ve a la pestaÃ±a 'Actions'"
        echo "2. Click en este workflow"
        echo "3. Descarga los artifacts"
